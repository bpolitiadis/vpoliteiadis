---
// Prerender this page for optimal performance
export const prerender = true;

import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import SchemaOrg from '../../components/SchemaOrg.astro';
import DecryptedText from '../../components/DecryptedText';
import AImage from '../../components/media/AImage.astro';
import blogBg from '../../assets/images/blog-bg.webp';
import { getCoverImage } from '../../lib/blog-images';

// Get all published blog posts and sort by date
const allPosts = await getCollection('blog');
const posts = allPosts
  .filter((post) => !post.data.draft)
  .sort(
    (a, b) =>
      new Date(b.data.publishedAt).getTime() -
      new Date(a.data.publishedAt).getTime()
  );

// SEO metadata
const title = 'Blog - Vasileios Politeiadis';
const description =
  'Insights on technology and creativity.';

// Build breadcrumb
const breadcrumbItems = [
  { name: 'Home', href: '/' },
  { name: 'Blog', href: '/blog' },
];

// Build Blog structured data
const blogSchema = {
  '@type': 'Blog',
  'name': 'Vasileios Politeiadis Blog',
  'description': description,
  'url': new URL('/blog', Astro.site).toString(),
  'blogPost': posts.slice(0, 10).map((post) => ({
    '@type': 'BlogPosting',
    'headline': post.data.title,
    'description': post.data.description,
    'author': {
      '@type': 'Person',
      'name': post.data.author,
    },
    'datePublished': new Date(post.data.publishedAt).toISOString(),
    'url': new URL(`/blog/${post.slug}`, Astro.site).toString(),
  })),
};
---

<MainLayout 
  title={title}
  description={description}
  currentPath="/blog"
  bgSlug="blog-bg"
  bgEager={true}
>
  <!-- Structured Data -->
  <SchemaOrg schema={blogSchema} />

  <!-- Breadcrumb (Hidden visually, visible to search engines) -->
  <Breadcrumb items={breadcrumbItems} class="sr-only" />

  <section
    class="relative pt-16 md:pt-20 lg:pt-24 pb-24 md:pb-32 px-4 sm:px-6 lg:px-8 bg-background overflow-hidden"
    role="region"
    aria-labelledby="blog-heading"
    data-testid="page-blog"
  >
    {/* Background image */}
    <div class="absolute inset-0 z-0 overflow-hidden">
      <AImage
        src={blogBg}
        alt=""
        preset="hero"
        class="w-full h-full object-cover object-center"
        aria-hidden="true"
      />
      <div class="absolute inset-0 bg-background/50"></div>
    </div>

    {/* Background decorative elements */}
    <div class="absolute inset-0 z-0 overflow-hidden pointer-events-none">
      <div class="absolute top-0 left-1/4 w-px h-32 bg-gradient-to-b from-primary/20 to-transparent" />
      <div class="absolute top-0 right-1/4 w-px h-32 bg-gradient-to-b from-secondary/20 to-transparent" />
      <div class="absolute bottom-0 left-1/2 w-px h-24 bg-gradient-to-t from-primary/10 to-transparent" />
    </div>

    <div class="max-w-7xl mx-auto relative z-10">
      {/* Section Headline - Tighter spacing for standalone page */}
      <div class="text-center mb-10 md:mb-12">
        <h2
          id="blog-heading"
          class="text-3xl md:text-4xl lg:text-5xl font-orbitron font-bold mb-3"
        >
          <DecryptedText
            client:visible
            text="Blog"
            speed={60}
            sequential={true}
            revealDirection="start"
            className="text-neon-lime text-shadow-neon"
            encryptedClassName="text-primary/40"
            parentClassName="block"
          />
        </h2>
        <p class="text-base md:text-lg text-matrix-white/70 font-inter max-w-2xl mx-auto">
          Insights on technology and creativity.
        </p>
      </div>

      {/* Blog Posts Grid - Full width, responsive columns */}
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8" id="posts-grid" data-testid="blog-posts-grid">
        {posts.map(post => (
          <BlogPostCard
            post={{
              slug: post.slug,
              title: post.data.title,
              excerpt: post.data.excerpt,
              description: post.data.description,
              coverImage: getCoverImage(post.data.coverImage),
              tags: post.data.tags,
              publishedAt: post.data.publishedAt,
              readingTime: post.data.readingTime
            }}
          />
        ))}
      </div>

      <!-- No Results Message -->
      <div id="no-results" class="hidden text-center py-12" aria-live="polite">
        <div class="text-6xl mb-4">üîç</div>
        <h3 class="text-xl font-orbitron font-bold text-matrix-white/60 mb-2">
          No articles found
        </h3>
        <p class="text-matrix-white/60">
          Try a different search or clear the tag filter
        </p>
      </div>
    </div>
  </section>
</MainLayout>

<script is:inline src="/scripts/blog-index.js" defer></script>