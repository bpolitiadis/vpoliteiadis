---
import { getImage } from 'astro:assets';
import vasileiosIllustration from '../../assets/images/vasileios-illustration.webp';
import laptopIllustration from '../../assets/images/laptop-illustration.webp';

// Generate optimized image data with explicit dimensions
const vasileiosImg = await getImage({
  src: vasileiosIllustration,
  widths: [480, 800, 1200],
  format: 'webp',
});

const laptopImg = await getImage({
  src: laptopIllustration,
  widths: [480, 800, 1200],
  format: 'webp',
});

// Generate AVIF srcsets for better compression
const vasileiosAvif480 = await getImage({ src: vasileiosIllustration, width: 480, format: 'avif' });
const vasileiosAvif800 = await getImage({ src: vasileiosIllustration, width: 800, format: 'avif' });
const laptopAvif480 = await getImage({ src: laptopIllustration, width: 480, format: 'avif' });
const laptopAvif800 = await getImage({ src: laptopIllustration, width: 800, format: 'avif' });
const laptopAvif1200 = await getImage({ src: laptopIllustration, width: 1200, format: 'avif' });

// Calculate aspect ratios for CLS prevention
const vasileiosAspectRatio = (vasileiosIllustration.width || 1177) / (vasileiosIllustration.height || 1374);
const laptopAspectRatio = (laptopIllustration.width || 559) / (laptopIllustration.height || 386);

// Preload critical hero image
const vasileiosPreload = await getImage({ src: vasileiosIllustration, width: 800, format: 'webp' });
---

<section
  class="relative mt-8 sm:mt-6 pt-2 sm:pt-4 lg:pt-0 px-4 sm:px-8 md:px-20 max-w-5xl pb-8 sm:pb-24 sm:min-h-[600px] lg:min-h-[769px] mx-auto sm:flex sm:flex-col sm:justify-center sm:items-center lg:flex-row-reverse"
  aria-label="Hero section"
  data-testid="hero-section"
>
  <!-- Preload critical LCP image -->
  <link rel="preload" as="image" href={vasileiosPreload.src} fetchpriority="high" />
  
  <!-- Image container with explicit aspect-ratio to prevent CLS -->
  <div 
    class="image-animation z-10 select-none mt-0 xs:mt-4 sm:mt-14 lg:mt-0 px-0 mx-auto mb-6 sm:mb-8 lg:mb-0 lg:p-0 lg:basis-1/3"
    style={`aspect-ratio: ${vasileiosAspectRatio};`}
  >
    <div 
      class="relative w-56 xs:w-64 sm:w-72 md:w-80 mx-auto"
      style={`aspect-ratio: ${vasileiosAspectRatio};`}
    >
      <!-- Character illustration - LCP element -->
      <div class="absolute pointer-events-none scale-75 xs:scale-85 sm:scale-90 mx-auto inset-0 flex items-center justify-center">
        <picture>
          <source
            srcset={`${vasileiosAvif480.src} 480w, ${vasileiosAvif800.src} 800w`}
            type="image/avif"
          />
          <source
            srcset={`${vasileiosImg.src} 1177w`}
            type="image/webp"
          />
          <img
            src={vasileiosImg.src}
            width={vasileiosIllustration.width || 1177}
            height={vasileiosIllustration.height || 1374}
            id="character-illustration"
            aria-label="Vasileios Politeiadis character illustration levitating with a Macbook"
            alt="Vasileios Politeiadis character illustration"
            loading="eager"
            fetchpriority="high"
            decoding="async"
            class="w-full h-full object-contain"
            style={`aspect-ratio: ${vasileiosAspectRatio};`}
          />
        </picture>
      </div>
      
      <!-- Laptop illustration -->
      <div 
        class="laptop absolute top-10 xs:top-12 sm:top-16 left-0 scale-[.32] xs:scale-[.38] sm:scale-[.41] pointer-events-none"
        style={`aspect-ratio: ${laptopAspectRatio}; width: ${(laptopIllustration.width || 559) * 0.41}px;`}
      >
        <picture>
          <source
            srcset={`${laptopAvif480.src} 480w, ${laptopAvif800.src} 800w, ${laptopAvif1200.src} 1200w`}
            type="image/avif"
          />
          <source
            srcset={`${laptopImg.src} 559w`}
            type="image/webp"
          />
          <img
            src={laptopImg.src}
            width={laptopIllustration.width || 559}
            height={laptopIllustration.height || 386}
            aria-hidden="true"
            alt=""
            loading="eager"
            fetchpriority="high"
            decoding="async"
            class="w-full h-full object-contain"
            style={`aspect-ratio: ${laptopAspectRatio};`}
          />
        </picture>
      </div>
    </div>
  </div>

  <!-- Text content -->
  <div class="lg:basis-2/3 z-10 relative px-2 sm:px-4 md:px-6 lg:px-0">
    <span class="text-primary lg:text-lg font-orbitron font-medium text-animation">
      Hi, my name is
    </span>
    <div class="overflow-hidden">
      <h1 class="text-animation text-4xl md:text-5xl lg:text-7xl md:my-2 font-orbitron font-bold my-1">
        Vasileios Politeiadis
      </h1>
    </div>
    <div class="overflow-hidden">
      <div class="text-animation text-xl md:text-2xl lg:text-4xl md:my-3 text-primary font-orbitron font-medium leading-tight">
        <div class="block">
          <span class="inline">QA Automation Engineer </span><span class="text-lg md:text-xl lg:text-3xl inline">&</span>
        </div>
        <div class="block">Full-Stack Developer</div>
      </div>
    </div>
    <div class="mt-2 my-3 sm:my-4 md:mb-8 overflow-hidden">
      <p class="text-animation mb-1 text-sm sm:text-base [&_strong]:[text-shadow:0_0_6px_rgba(57,255,20,0.3)]">
        I break your code professionally using <strong>Playwright</strong> and <strong>Selenium</strong>. When I'm not hunting down bugs, I build full-stack applications with <strong>Next.js</strong> and <strong>Supabase</strong>, craft lightning-fast websites with <strong>Astro</strong> and <strong>TailwindCSS</strong>, and automate boring workflows with <strong>n8n</strong> and custom AI agents that actually work.
      </p>
    </div>
    <a
      href="#contact"
      class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2 mt-2 sm:mt-4"
    >
      Contact me
      <svg class="w-4 h-4" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
      </svg>
    </a>
  </div>
  
  <!-- Scroll indicator -->
  <a
    href="#about"
    class="group absolute link-outline animate-bounce hidden md:bottom-14 lg:bottom-16 left-1/2 transform -translate-x-1/2 md:flex items-center flex-col"
  >
    <span class="text-secondary text-shadow-emerald group-hover:text-shadow-none transition-all duration-200">
      Scroll
    </span>
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      class="fill-secondary drop-shadow-[0_0_8px_rgba(0,184,107,0.5)] group-hover:drop-shadow-[0_0_12px_rgba(0,184,107,0.7)] transition-all duration-200"
      aria-hidden="true"
    >
      <path d="M11.975 22H12c3.859 0 7-3.14 7-7V9c0-3.841-3.127-6.974-6.981-7h-.06C8.119 2.022 5 5.157 5 9v6c0 3.86 3.129 7 6.975 7zM7 9a5.007 5.007 0 0 1 4.985-5C14.75 4.006 17 6.249 17 9v6c0 2.757-2.243 5-5 5h-.025C9.186 20 7 17.804 7 15V9z"></path>
      <path d="M11 6h2v6h-2z"></path>
    </svg>
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      class="fill-secondary drop-shadow-[0_0_8px_rgba(0,184,107,0.5)] group-hover:drop-shadow-[0_0_12px_rgba(0,184,107,0.7)] transition-all duration-200"
      aria-hidden="true"
    >
      <path d="M16.293 9.293 12 13.586 7.707 9.293l-1.414 1.414L12 16.414l5.707-5.707z"></path>
    </svg>
  </a>
</section>

<!-- GSAP animations script - loads after critical content -->
<script>
  // Wait for DOM, fonts, and GSAP to load
  function initAnimations() {
    // GSAP is loaded via CDN in MainLayout - check availability
    // @ts-expect-error - GSAP is loaded via CDN and available on window
    if (typeof window === 'undefined' || typeof window.gsap === 'undefined') {
      // Retry after GSAP loads (max 20 attempts = 2 seconds)
      // @ts-expect-error - Custom property for retry tracking
      if (typeof window !== 'undefined' && (window.initAnimationAttempts || 0) < 20) {
        // @ts-expect-error - Custom property for retry tracking
        window.initAnimationAttempts = (window.initAnimationAttempts || 0) + 1;
        setTimeout(initAnimations, 100);
      }
      return;
    }
    
    // @ts-expect-error - GSAP is loaded via CDN and available on window
    const gsap = window.gsap;
    const section = document.querySelector('[data-testid="hero-section"]');
    if (!section) return;

    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const isMobile = window.innerWidth < 640;

    const q = gsap.utils.selector(section);

    // Text slide-up animation
    const textTimeline = gsap.timeline({
      defaults: {
        stagger: 0.2,
        duration: 0.3,
      },
    });

    if (!prefersReducedMotion) {
      textTimeline.fromTo(
        q('.text-animation'),
        { y: 100, opacity: 0 },
        { y: 0, opacity: 1, delay: 1 }
      );
    } else {
      textTimeline.fromTo(
        q('.text-animation'),
        { opacity: 0 },
        { opacity: 1, delay: 1 }
      );
    }

    // Illustration floating effect
    const imageTimeline = gsap.timeline({ repeat: -1 });
    if (!prefersReducedMotion) {
      const movements = isMobile
        ? [
            { y: '-=15', x: '+=10', rotation: '-=1' },
            { y: '+=15', x: '-=10', rotation: '-=1' },
            { y: '-=10', rotation: '+=1' },
            { y: '+=10', rotation: '+=1' },
          ]
        : [
            { y: '-=30', x: '+=20', rotation: '-=2' },
            { y: '+=30', x: '-=20', rotation: '-=2' },
            { y: '-=20', rotation: '+=2' },
            { y: '+=20', rotation: '+=2' },
          ];
      const durations = [3, 2, 3, 3];
      movements.forEach((movement, index) => {
        imageTimeline.to(q('.image-animation'), {
          ...movement,
          ease: 'power1.easeInOut',
          duration: durations[index],
        });
      });
    }

    // Laptop floating effect
    const laptopTimeline = gsap.timeline({ repeat: -1 });
    if (!prefersReducedMotion) {
      const movements = isMobile
        ? [
            { y: '-=5', x: '+=5', rotation: '-=0.5' },
            { y: '+=5', x: '-=5', rotation: '-=0.5' },
            { y: '-=5', rotation: '+=0.5' },
            { y: '+=5', rotation: '+=0.5' },
          ]
        : [
            { y: '-=10', x: '+=10', rotation: '-=1' },
            { y: '+=10', x: '-=10', rotation: '-=1' },
            { y: '-=10', rotation: '+=1' },
            { y: '+=10', rotation: '+=1' },
          ];
      const durations = [3, 2, 3, 3];
      movements.forEach((movement, index) => {
        laptopTimeline.to(q('.laptop'), {
          ...movement,
          ease: 'power1.easeInOut',
          duration: durations[index],
        });
      });
    }
  }

  // Initialize when DOM is ready and GSAP is loaded
  if (typeof window !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAnimations);
    } else {
      // Wait for GSAP to be available
      // Using any to avoid type conflict between browser (number) and Node (Timer) types
      const checkGSAP: any = setInterval(() => {
        // @ts-expect-error - GSAP is loaded via CDN and available on window
        if (typeof window.gsap !== 'undefined') {
          clearInterval(checkGSAP);
          initAnimations();
        }
      }, 50);
      // Fallback timeout
      setTimeout(() => {
        clearInterval(checkGSAP);
        // @ts-expect-error - GSAP is loaded via CDN and available on window
        if (typeof window.gsap !== 'undefined') {
          initAnimations();
        }
      }, 2000);
    }
  }
</script>
