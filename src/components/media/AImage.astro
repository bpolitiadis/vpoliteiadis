---
/**
 * AImage - Unified Image Component
 * 
 * Golden Path: Always prefer imported ImageMetadata from src/assets/images/
 * Legacy: Static paths from public/images/ are supported but deprecated
 * 
 * @see docs/IMAGE_STRATEGY.md for usage guidelines
 */
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import { imagePresets, defaultPreset } from '../../lib/image-presets';

export interface Props {
  /** ImageMetadata (preferred) or static path string (legacy) */
  src: ImageMetadata | string;
  /** Alt text - required for accessibility */
  alt: string;
  /** Explicit width - REQUIRED for above-the-fold images to prevent CLS */
  width?: number;
  /** Explicit height - REQUIRED for above-the-fold images to prevent CLS */
  height?: number;
  /** Additional CSS classes */
  class?: string;
  /** Responsive preset (hero, card, thumb) */
  preset?: keyof typeof imagePresets;
  /** Custom sizes attribute (overrides preset default) */
  sizes?: string;
  /** Loading strategy - use 'eager' for LCP images */
  loading?: 'eager' | 'lazy';
  /** Decoding strategy */
  decoding?: 'auto' | 'sync' | 'async';
  /** Fetch priority - use 'high' for LCP images */
  fetchpriority?: 'high' | 'low' | 'auto';
  /** 
   * @deprecated Use imported ImageMetadata instead
   * Enable picture element with srcset for static images (default: true)
   */
  usePicture?: boolean;
}

const {
  src,
  alt,
  width,
  height,
  class: className = '',
  preset,
  sizes,
  loading = 'lazy',
  decoding = 'async',
  fetchpriority = 'auto',
  usePicture = true,
} = Astro.props;

const selectedPreset = preset ? imagePresets[preset] : defaultPreset;
const computedSizes = sizes ?? selectedPreset.sizes;

// Type guard: Check if src is an imported image (ImageMetadata) or static path (string)
const isImportedImage = typeof src === 'object' && 'src' in src;

// Legacy support: Helper function to generate srcset for static images
// @deprecated - Migrate to imported ImageMetadata
function generateSrcSet(basePath: string, widths: number[], format: 'webp' | 'avif'): string {
  return widths
    .map((w) => `${basePath}-${w}w.${format} ${w}w`)
    .join(', ');
}

// Legacy support: Extract base path and check for optimized variants
// @deprecated - Migrate to imported ImageMetadata
function getOptimizedImagePaths(staticPath: string, widths: number[]) {
  const basePath = staticPath.replace(/^\//, '').replace(/\.(png|jpg|jpeg|webp|avif)$/i, '');
  const fullBasePath = `/${basePath}`;
  
  return {
    avifSrcSet: generateSrcSet(fullBasePath, widths, 'avif'),
    webpSrcSet: generateSrcSet(fullBasePath, widths, 'webp'),
    fallbackSrc: staticPath,
    basePath: fullBasePath,
  };
}
---

{isImportedImage ? (
  // ✅ PREFERRED: Use Astro's Image component for imported images
  // Astro 5 automatically optimizes to AVIF/WebP and generates responsive srcset
  <Image
    src={src as ImageMetadata}
    alt={alt}
    widths={selectedPreset.widths}
    sizes={computedSizes}
    format="webp"
    class={className}
    loading={loading}
    decoding={decoding}
    fetchpriority={fetchpriority}
    {...(width ? { width } : {})}
    {...(height ? { height } : {})}
  />
) : usePicture ? (
  // ⚠️ LEGACY: Picture element for static images (deprecated)
  // Migrate to imported ImageMetadata from src/assets/images/
  (() => {
    const staticPath = src as string;
    const paths = getOptimizedImagePaths(staticPath, selectedPreset.widths);
    return (
      <picture>
        <source
          type="image/avif"
          srcset={paths.avifSrcSet}
          sizes={computedSizes}
        />
        <source
          type="image/webp"
          srcset={paths.webpSrcSet}
          sizes={computedSizes}
        />
        <img
          src={paths.fallbackSrc}
          alt={alt}
          width={width}
          height={height}
          class={className}
          loading={loading}
          decoding={decoding}
          fetchpriority={fetchpriority}
        />
      </picture>
    );
  })()
) : (
  // ⚠️ LEGACY: Regular img tag fallback (deprecated)
  // Migrate to imported ImageMetadata from src/assets/images/
  <img
    src={src as string}
    alt={alt}
    width={width}
    height={height}
    class={className}
    sizes={computedSizes}
    loading={loading}
    decoding={decoding}
    fetchpriority={fetchpriority}
  />
)}


